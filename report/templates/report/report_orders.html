{% extends "main/base.html" %}

{% block title_h1 %}Отчет: Заказы (Статус/Оплата/Источник){% endblock %}
{% block breadcrumb_buttons %}
<button id="dashboardDate3" name="DatePick" class="btn btn-default dropdown-toggle mr-2 d-none d-md-block pd-y-8-force"></button>
{% endblock %}

{% block body_content %}
                     <!-- Filtering FooTable Start -->
                     <!--================================-->
                     <div class="col-md-12 col-lg-12">




                            <div class="row clearfix">
                              <div class="col-lg-6">
                                 <div class="card mg-b-30">
                                    <div class="card-body">
                                       <div class="row">
                                          <div class="col-md-5 col-lg-4 col-xl-6 order-1 order-sm-0 mg-t-20 mg-sm-t-0">
                                             <div class="clearfix">
                                                <div id="flotBarRecentOrders" style="height: 100px"></div>
                                             </div>
                                          </div>
                                          <div class="col-md-7 col-lg-8 col-xl-6">
                                             <div class="pd-0">
                                                <div class="d-flex align-items-baseline mg-b-5">
                                                   <h1 class="tx-20 tx-sm-18 tx-md-24 mg-b-0 tx-rubik tx-dark tx-normal">{{qs_count1}}</h1>
                                                   <span class="d-flex align-items-center tx-success mg-l-2 tx-10"><i class="ti-arrow-up tx-8 tx-success tx-8 mr-1"></i>11.24%</span>
                                                </div>
                                                <h6 class="tx-11 tx-primary tx-uppercase">Созданных заказов</h6>
                                                <p class="tx-11 tx-sm-12 mg-b-0 tx-gray-500">За период<span class="d-none d-sm-inline"> {{ period }}</span></p>
                                             </div>
                                          </div>
                                       </div>
                                       <!-- row -->
                                    </div>
                                 </div>
                                 <!-- card -->
                              </div>
                              <div class="col-lg-6">
                                 <div class="card mg-b-30">
                                    <div class="card-body">
                                       <div class="row">
                                          <div class="col-md-5 col-lg-4 col-xl-6 order-1 order-sm-0 mg-t-20 mg-sm-t-0">
                                             <div class="clearfix">
                                                <div id="flotBarCompleteOrders" style="height: 100px"></div>
                                             </div>
                                          </div>
                                          <div class="col-md-7 col-lg-8 col-xl-6">
                                             <div class="pd-0">
                                                <div class="d-flex align-items-baseline mg-b-5">
                                                   <h1 class="tx-20 tx-sm-18 tx-md-24 mg-b-0 tx-rubik tx-dark tx-normal">{{qs_count2}}</h1>
                                                   <span class="d-flex align-items-center tx-danger mg-l-2 tx-10"><i class="ti-arrow-down tx-8 tx-danger tx-8 mr-1"></i>10.9%</span>
                                                </div>
                                                <h6 class="tx-11 tx-pink tx-uppercase">Выполненных заказов</h6>
                                                <p class="tx-12 mg-b-0 tx-gray-500">За период<span class="d-none d-sm-inline"> {{ period }}</span></p>
                                             </div>
                                          </div>
                                       </div>
                                       <!-- row -->
                                    </div>
                                 </div>
                                 <!-- card -->
                              </div>
                           </div>

                            <div class="row">
                                <div class="col-md-6">
                                   <div class="card mg-b-30">
                                      <div class="card-body">
                                         <div class="pd-b-20">
                                            <h3 class="tx-11 tx-uppercase tx-spacing-1 tx-semibold mg-b-0">Соотношение по статусам</h3>
                                            <p class="tx-13 tx-gray-500 mb-0">За период<span class="d-none d-sm-inline"> {{ period }}</span></p>
                                         </div>
                                         <div class="d-flex align-items-center">
                                            <canvas id="myChart9" height="80">
                                         </div>
                                      </div>
                                   </div>
                                </div>
                                <div class="col-md-6">
                                       <div class="card mg-b-30">
                                          <div class="card-body">
                                             <div class="pd-b-20">
                                                <h3 class="tx-11 tx-uppercase tx-spacing-1 tx-semibold mg-b-0">Соотношение по источнику</h3>
                                                <p class="tx-13 tx-gray-500 mb-0">За период<span class="d-none d-sm-inline"> {{ period }}</span></p>
                                             </div>
                                             <div class="d-flex align-items-center">
                                                <canvas id="myChart10" height="80">
                                             </div>
                                          </div>
                                       </div>
                                </div>
                             </div>

                           <div class="card-body pd-0">

                               <div class="row">
                                 <div class="mg-20 form-inline wd-100p">

                                    <div class="col-sm-6">
                                       <div class="form-group">
                                           <div class="d-flex align-items-center">

                                                <span id="startDateY" hidden> {{ startDate.0 }}</span>
                                                <span id="startDateM" hidden> {{ startDate.1 }}</span>
                                                <span id="startDateD" hidden> {{ startDate.2 }}</span>
                                                <span id="endDateY" hidden> {{ endDate.0 }}</span>
                                                <span id="endDateM" hidden> {{ endDate.1 }}</span>
                                                <span id="endDateD" hidden> {{ endDate.2 }}</span>
                                           </div>
                                          <select id="foo-filter-status" class="custom-select">
                                             <option value="">Показать все</option>
                                              {% for q in category %}
                                                <option value="{{q.name}}">{{q.name}}</option>
                                              {% endfor %}

                                          </select>
                                       </div>
                                    </div>
                                    <div class="col-sm-6">
                                       <div class="form-group ft-right">
                                          <input id="foo-search" type="text" placeholder="Поиск" class="form-control" autocomplete="off">
                                       </div>
                                    </div>
                                 </div>
                         </div>

                              <table id="foo-filtering" class="table table-hover mg-0" data-page-size="50">
                                  <thead class="tx-10 tx-uppercase">
                                     <tr>
                                        <th>ID заказа</th>
                                         <th>Создан</th>
                                        <th>Клиент</th>
                                        <th>Источник</th>
                                        <th>Статус</th>
                                         <th>Статус оплат</th>
                                         <th>Оплаты</th>
                                        <th class="tx-right">Действия</th>
                                     </tr>
                                  </thead>
                                 <tbody>
                                    {% for q in orders %}

                                        <tr>
                                            <td><a href="{% url 'manager:order_view' q.id %}">{{q.number}}</a></td>
                                            <td>{{q.date_created|date:'d/m/Y'}}</td>
                                            <td><a href="">
                                                {% for cus in customer %}
                                                    {% for ord in cus.order.all %}
                                                        {% if q.number == ord.number %}
                                                            {{cus.name}}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}
                                            </a></td>
                                            <td>
                                                {% for cus in customer %}
                                                    {% for ord in cus.order.all %}
                                                        {% if q.number == ord.number %}
                                                            {{cus.get_source_t_display}}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}
                                            </td>

                                            <td><span class="badge badge-{{q.get_status_css_display}}">{{q.get_status_display}}</span></td>
                                            <td>
                                                {% if q.status > 5 %}
                                                    {{ order_test|get_item:q.number|get_item:"progress" }}%
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if q.status > 5 %}
                                                    {{ order_test|get_item:q.number|get_item:"status" }} руб.
                                                {% endif %}
                                            </td>
                                            <td class="tx-right">
                                                {% if q.status > 4 %}
                                                    {% if q.status == 10 %}
                                                        <a href="{% url 'manager:order_budget_view' q.id %}"  title="" data-toggle="tooltip" data-original-title="Бюджет"><i data-feather="dollar-sign" class="wd-16 mr-2"></i></a>
                                                    {% else %}
                                                        <a href="{% url 'manager:order_view' q.id %}"  title="" data-toggle="tooltip" data-original-title="Заказать"><i data-feather="crosshair" class="wd-16 mr-2"></i></a>
                                                        <a href="{% url 'manager:order_budget_view' q.id %}"  title="" data-toggle="tooltip" data-original-title="Бюджет"><i data-feather="dollar-sign" class="wd-16 mr-2"></i></a>
                                                    {% endif %}
                                                {% else %}
                                                    <a href="{{ q.get_absolute_url}}"  title="" data-toggle="tooltip" data-original-title="Изменить"><i data-feather="edit-3" class="wd-16 mr-2"></i></a>
                                                    <a href="{{ q.archive}}" title="" data-toggle="tooltip" data-original-title="В архив"><i data-feather="archive" class="wd-16"></i></a>
                                                {% endif %}

                                            </td>
                                        </tr>
                                    {% endfor %}

                                 </tbody>
                                 <tfoot>
                                    <tr>
                                       <td colspan="5">
                                          <div class="ft-right">
                                             <ul class="pagination"></ul>
                                          </div>
                                       </td>
                                    </tr>
                                 </tfoot>
                              </table>
                           </div>

                     </div>
                     <!--/ Filtering FooTable End -->
<script src="/static/main/assets/plugins/chartjs/chartjs.js"></script>
 <script src="/static/main/assets/plugins/chartjs/chartjs-active.js"></script>

 <script>
    var ctx = document.getElementById('myChart9').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'doughnut',// bar, horizontalBar, pie, line, doughnut, radar, polarArea

        data: {
            labels: {{ cus_label|safe }},
            datasets: [{
                data: {{ cus_data|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ]
            }]
        },
        options: {
            legend: {
                display: true,
                position: 'right',
                labels: {
                    fontColor: '#000'
                }
            }

        }


    });

    var ctx = document.getElementById('myChart10').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'doughnut',// bar, horizontalBar, pie, line, doughnut, radar, polarArea

        data: {
            labels: {{ cus_label2|safe }},
            datasets: [{
                data: {{ cus_data2|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ]
            }]
        },
        options: {
            legend: {
                display: true,
                position: 'right',
                labels: {
                    fontColor: '#000'
                }
            }

        }


    });
  </script>
<script src="/static/main/assets/plugins/jquery/jquery.min.js"></script>
<script src="/static/main/assets/plugins/jquery-ui/jquery-ui.js"></script>
<script src="/static/main/assets/plugins/flot/jquery.flot.js"></script>
<script src="/static/main/assets/plugins/flot/jquery.flot.pie.js"></script>
<script src="/static/main/assets/plugins/flot/jquery.flot.resize.js"></script>
<script src="/static/main/assets/plugins/flot/sampledata.js"></script>

<script>
! function (e) {
	"use strict";

    function xAxisLabelGenerator(x){
    return xAxisLabels[x];
    }

	// Float Bar Chat
	var flotChartOption1 = {
		series: {
			shadowSize: 0,
			bars: {
				show: true,
				lineWidth: 0,
				barWidth: .5,
				fill: 1
			}
		},
		grid: {
			aboveData: true,
			color: '#e5e9f2',
			borderWidth: 0,
			labelMargin: 0
		},
		yaxis: {
			show: false,
			min: 0,
			max: 15
		},
		xaxis: {
			show: false,
			mode: 'Categories',
		}
	};

	$.plot('#flotBarRecentOrders', [{

		data: {{data1|safe}},
		color: '#66a4fb'
	}], flotChartOption1);


	$.plot('#flotBarCompleteOrders', [{

		data: {{data2|safe}},
		color: '#e83e8c'
	}], flotChartOption1);

}(jQuery);


</script>

<script>

     // Dashboard DateTimePicker
     $(function() {
     var isRtl = $('body').attr('dir') === 'rtl' || $('html').attr('dir') === 'rtl';

     // Button
     var startY = document.getElementById( 'startDateY' );
     var startM = document.getElementById( 'startDateM' );
     var startD = document.getElementById( 'startDateD' );
     var endY = document.getElementById( 'endDateY' );
     var endM = document.getElementById( 'endDateM' );
     var endD = document.getElementById( 'endDateD' );


     var start = moment([Number(startY.textContent), Number(startM.textContent), Number(startD.textContent)]);
     var end = moment([Number(endY.textContent), Number(endM.textContent), Number(endD.textContent)]);


     function cb(start, end) {
     $('#dashboardDate3').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
     }
     $('#dashboardDate3').daterangepicker({
     startDate: start,
     endDate: end,
     ranges: {
     'Сегодня': [moment(), moment()],
     'Вчера': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
     'Последние 7 дней': [moment().subtract(6, 'days'), moment()],
     'Последние 30 дней': [moment().subtract(29, 'days'), moment()],
     'Это месяц': [moment().startOf('month'), moment().endOf('month')],
     'Предыдущий месяц': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
     },
     opens: (isRtl ? 'left' : 'right')
     }, cb);
     cb(start, end);

     // Replace icons
     $('#dashboardDate3').each(function() {
     var obj = $(this).data('daterangepicker');
     var _updateCalendars = obj.updateCalendars;
     obj.updateCalendars = function() {
     // Call original function
     _updateCalendars.call(obj)
     // Replace icons
     obj.container.find('.prev > i').each(function() { this.className = 'ion ion-ios-arrow-back' });
     obj.container.find('.next > i').each(function() { this.className = 'ion ion-ios-arrow-forward' });
     obj.container.find('.daterangepicker_input > i').each(function() { this.className = 'ion ion-md-calendar' });
     obj.container.find('.calendar-time > i').each(function() { this.className = 'ion ion-md-time' });

     };
     });

      $('#dashboardDate3').on('apply.daterangepicker', function(ev, picker) {

        var start = (picker.startDate.format('YYYY-MM-DD'));
        var end = (picker.endDate.format('YYYY-MM-DD'));

        var link = '{% url 'report:orders_date' 'val1' 'val2' %}';
        link = link.replace('val1', start);
        link = link.replace('val2', end);
        window.location.href = link;
      });
     });
</script>


{% endblock %}

